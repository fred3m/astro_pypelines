<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>Interactive Plot</title>
        <script src="static/jquery-2.1.0.min.js" type="text/javascript"></script>
        <script src="static/astropyp.js" type="text/javascript"></script>
        <!-- Place any other scripts needed here (example below)-->
        <script src="interactive_plots/static/plots.js" type="text/javascript"></script>
    </head>
    <body>
        <!-- Div element to hold parameter elements -->
        <div id='parameter-div'>
            <center class='pyp-title'>Parameters</center>
            <div id='param_list-div'></div>
        </div>
        <!-- Div element for instructions elements -->
        <div id='plot-div'></div>
        <div id='file-dialog'></div>
        <script>
        var websocket;
        var param_height = 98; // % of screen height
        var plot_height = 98; // % of screen height
        var param_list;
        var plot_data;
        var chart;
        var plot_title;
        
        function rxMsg(msg){
            // Actions to be taken based on message type
            if(msg.id == 'plot table'){
                plot_data = []
                $.each(msg.data, function(i, entry){
                    var record = {};
                    $.each(msg.columns, function(j, column){
                        record[column] = entry[j]
                    });
                    plot_data.push(record);
                });
                console.log('data', plot_data);
                
                // clear fields from last table
                param_list.params.params.x_axis.$input.html('');
                param_list.params.params.y_axis.$input.html('');
                param_list.params.params.show_x_error_div.paramSets.true.params.x_error.$input.html('');
                param_list.params.params.show_y_error_div.paramSets.true.params.y_error.$input.html('');
                param_list.params.params.group_div.paramSets.true.params.group_var.$input.html('');
                
                for(var i=0; i<msg.columns.length; i++){
                    var column = msg.columns[i];
                    $option = $('<option/>').html(column).val(column);
                    $option.clone().appendTo(param_list.params.params.x_axis.$input);
                    $option.clone().appendTo(param_list.params.params.y_axis.$input);
                    $option.clone().appendTo(param_list.params.params.show_x_error_div.paramSets.true.params.x_error.$input);
                    $option.clone().appendTo(param_list.params.params.show_y_error_div.paramSets.true.params.y_error.$input);
                    $option.clone().appendTo(param_list.params.params.group_div.paramSets.true.params.group_var.$input);
                };
                param_list.params.params.y_axis.$input.val(msg.columns[1]);
                plot_title = msg.title;
            }
        };
        
        function buildPlot(){
            var data = plot_data.slice(0);
            var params = param_list.getParams(param_list.params);
            
            function x_sort(a,b){
                if(a[params.x_axis]<b[params.x_axis]){
                    return -1;
                }else if(a[params.x_axis]>b[params.x_axis]){
                    return 1;
                };
                return 0;
            };
            
            function findUnique(array, key){
                var values = [];
                for(var i=0; i<array.length; i++){
                    if(values.indexOf(array[i][key])==-1){
                        values.push(array[i][key]);
                    }
                }
                return values;
            };
            
            data.sort(x_sort);
            for(var i=0; i<data.length; i++){
                data[i]['x']=data[i][params.x_axis];
                data[i]['y']=data[i][params.y_axis];
            };
            console.log('chart data:',data);
            var series_data = [];
            
            if(params.show_y_error){
                var err_data = [];
                $.each(data,function(i, entry){
                    console.log('entry:',entry);
                    var err = entry[params.y_error];
                    err_data.push({
                        x: entry['x'],
                        low: entry['y']-err,
                        high: entry['y']+err
                    })
                });
                console.log(err_data);
                series_data.push({
                    type: 'errorbar',
                    data: err_data
                })
            };
            if(params.show_x_error){
                var err_data = [];
                $.each(data,function(i, entry){
                    console.log('entry:',entry);
                    var err = entry[params.x_error];
                    err_data.push({
                        x: entry['x'],
                        low: entry['y']-err,
                        high: entry['y']+err
                    })
                });
                console.log(err_data);
                series_data.push({
                    type: 'errorbar',
                    data: err_data
                })
            };
            
            if(params.group){
                var keys = findUnique(data, params.group_var);
                console.log('keys:', keys);
                var data_sets = {};
                for(var i=0; i<keys.length; i++){
                    data_sets[keys[i]] = [];
                };
                console.log('data_sets:', data_sets);
                for(var i=0; i<data.length; i++){
                    data_sets[data[i][params.group_var]].push(data[i]);
                };
                for(var i=0; i<keys.length; i++){
                    series_data.push({
                        name: keys[i],
                        type: 'line',
                        turboThreshold:plot_data.length+10,
                        data:data_sets[keys[i]],
                        allowPointSelect:true,
                        marker:{
                            enabled:true,
                            symbol:'circle',
                            radius: 4
                        }
                    })
                };
            } else {
                series_data.push({
                    type:'line',
                    //color: 'rgba(223, 83, 83, .5)',
                    turboThreshold:plot_data.length+10,
                    data:data,
                    allowPointSelect:true,
                    marker:{
                        enabled:true,
                        symbol:'circle',
                        radius: 4
                    }
                })
            }
            
            console.log('series data', series_data);
            
            chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'plot-div',
                    zoomType: 'xy',
                    events: {
                        selection: function(event) {
                        //return false;
                        }
                    },
                },
                title: {
                    text: plot_title
                },
                xAxis: {
                    title: {
                        enabled: true,
                        text: params.x_axis
                    },
                    startOnTick: true,
                    endOnTick: true,
                    showLastLabel: true
                },
                yAxis: {
                    title: {
                        text: params.y_axis
                    },
                    //reversed:true
                },
                tooltip: {
                    formatter: function() {
                        obs_info = '';
                        for(field in plot_data[0]){
                            obs_info += field+': '+this.point[field]+'<br/>';
                        };
                        return obs_info;
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'left',
                    verticalAlign: 'top',
                    x: 100,
                    y: 70,
                    floating: true,
                    backgroundColor: '#FFFFFF',
                    borderWidth: 1
                },
                plotOptions: {
                    scatter: {
                        marker: {
                            radius: 5,
                            states: {
                                hover: {
                                    enabled: true,
                                    lineColor: 'rgb(100,100,100)'
                                }
                            }
                        },
                        states: {
                            hover: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },
        
                    cursor: 'pointer',
                    events: {
                        /*click: function(event) {
                            console.log("point:",event.point);
                            loadInfo(event.point);
                        }*/
                    }
                    },
                },
                series: series_data
            });
        }
        
        function loadTable(){
            websocket.sendTask({
                module: 'interactive_plots.plots',
                task: 'load_table',
                parameters: {
                    filename: param_list.params.params.filename.$input.val()
                }
            });
        }
        
        
        function pypeline_onload(options){
            console.log('Dependencies loaded!')
            
            file_dialog = Astropyp.Utils.initFileDialog({
                element:'file-dialog',
                websocket:websocket
            });
            
            var params = Astropyp.Pypelines.Plots.initParams({
                file_dialog: file_dialog,
                buildPlotFunc: buildPlot,
                loadFunc: loadTable
            })
            
            param_list = Astropyp.Utils.initParamList(
                {
                    type:'div',
                    params:params.scatter
                },
                options = {
                    $parent: $('#param_list-div')
                }
            );
            
            param_list.params.params.filename.$input.change(function(){
                
            });
        };
        
        window.onload = function(){
            websocket = Astropyp.Core.jobsocketInit({
                receiveAction:rxMsg
            });
            Astropyp.Utils.loadDependencies(
                Astropyp.Pypelines.Plots.dependencies, 
                pypeline_onload,
                {}
            );
            $('#parameter-div').height(Math.floor($(window).height()*param_height/100));
            $('#plot-div').height(Math.floor($(window).height()*plot_height/100));
        };
        
        window.onresize = function(){
            $('#parameter-div').height(Math.floor($(window).height()*param_height/100));
            $('#plot-div').height(Math.floor($(window).height()*plot_height/100));
        }
        </script>
    </body>
</html>